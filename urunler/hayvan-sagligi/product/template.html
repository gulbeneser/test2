    import { GoogleGenerativeAI } from "https://esm.sh/@google/generative-ai";

    const GEMINI_API_KEY = "AIzaSyBEpqKAEZKYSyznxeZsQ1MYO-9hqV5LGoA"; 
    const FALLBACK_IMAGE_URL = '/urunler/assets/logos/resimyok.png';
    const API_BASE_PATH = '/urunler/api/'; 
    const GEMINI_SDK_LOADED = typeof GoogleGenerativeAI !== 'undefined';
    // MAX_COMPARE_ITEMS kaldırıldı

    let allProducts = []; 
    let currentSegment = ''; 
    let currentProduct = null;
    let favorites = [];
    // comparisonList kaldırıldı
    let searchDebounceTimer;
    let G_isMouseOverDropdown = false; 

    async function generateEnhancedProductInfo(productName, productKategori, languageCode, existingProductInfo = {}) {
        // ... (Bu fonksiyon aynı kalabilir, sadece keyFeatures için daha esnek kontrol eklendi bir önceki adımda) ...
        // İçerik bir önceki versiyondaki gibi kalacak
        if (!GEMINI_SDK_LOADED) throw new Error("Yapay zeka modülü (SDK) yüklenemedi.");
        
        let isGeminiEnabled = false;
        if (GEMINI_SDK_LOADED) {
            if (GEMINI_API_KEY === "AIzaSyBEpqKAEZKYSyznxeZsQ1MYO-9hqV5LGoA") { // Demo key
                isGeminiEnabled = true;
            } else if (GEMINI_API_KEY && !GEMINI_API_KEY.includes("PLACEHOLDER")) { // Other valid key
                isGeminiEnabled = true;
            }
        }
        if (!isGeminiEnabled) {
            throw new Error("Gemini API anahtarı yapılandırılmamış veya SDK yüklenememiş.");
        }

        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({ 
            model: "gemini-2.5-flash-preview-05-20", 
            generationConfig: { responseMimeType: "application/json" } 
        });

        const basePrompt = `
            Sen bir hayvan sağlığı ve dermokozmetik ürün uzmanısın. Müşterilere ürünler hakkında, profesyonel bilgiler sağlıyorsun Cevaplar kısa ve öz olsun. 
            Lütfen "${productName}" isimli ve "${productKategori}" kategorisindeki ürün için aşağıdaki JSON formatında bilgiler sun. 
            Mevcut bilgiler: 
            - Açıklama: ${existingProductInfo.description || 'Yok'}
            - İçerik: ${existingProductInfo.content || 'Yok'}
            
            Çıktı JSON nesnesi olmalı ve SADECE aşağıdaki anahtarları içermelidir Eğer bilmiyorsan cevap verme, mümkünse ürünün resmi web sitesi ile birebir aynı açıklamalar cümleler kullanılmalı:
            1.  "enhancedDescription": Profesyonel kısa açıklaması. Mevcut açıklamayla varsa ÇAKIŞMAMALI.
            2.  "keyFeatures": Ne işe yarar?, İçeriği (Composition) , Kullanım Alanları ve kulanım hayvanları (Indications), Kontrendikasyonlar (Contraindications), Dozaj ve Uygulama (Dosage and Administration),Yan Etkiler (Side Effects), Uyarılar ve Önlemler (Precautions and Warnings), İlaç Kalıntı Süresi / İnsan Tüketimi Uyarısı (Withdrawal Times), Saklama Koşulları (Storage Conditions)
          

Ambalaj (Packing).. Eğer bir cevap bulmaz isen "Ürün hakkında detaylı bilgi bulunmamaktadır" şeklinde cevap ver 
            1.  "enhancedDescription":  

            Örnek JSON:
            {
              "enhancedDescription": "Bu ürün...",
              "keyFeatures": ["Özellik 1", "Özellik 2"]
            }
            Cevabını Türkçe olarak oluştur.
        `;

        try {
            const result = await model.generateContent(basePrompt);
            const response = result.response;
            let jsonStr = response.text().replace(/^```(?:json)?\s*\n?(.*?)\n?\s*```$/s, '$1').trim();
            const parsedData = JSON.parse(jsonStr);
            if (!parsedData.enhancedDescription) throw new Error("Yapay zekadan beklenen 'enhancedDescription' alanı alınamadı.");
            if (!parsedData.keyFeatures) parsedData.keyFeatures = []; 
            return parsedData; 
        } catch (error) {
            console.error("Gemini API ile gelişmiş ürün bilgisi üretilirken hata oluştu:", error);
            throw new Error(`AI bilgi üretilemedi: ${error.message || 'Bilinmeyen Hata'}`);
        }
    }

    async function generateChatResponse(productName, category, question, chatHistory = []) {
        // ... (Bu fonksiyon aynı kalabilir) ...
        // İçerik bir önceki versiyondaki gibi kalacak
         let isGeminiEnabled = false;
        if (GEMINI_SDK_LOADED) {
            if (GEMINI_API_KEY === "AIzaSyBEpqKAEZKYSyznxeZsQ1MYO-9hqV5LGoA") {
                isGeminiEnabled = true;
            } else if (GEMINI_API_KEY && !GEMINI_API_KEY.includes("PLACEHOLDER")) {
                isGeminiEnabled = true;
            }
        }
        if (!isGeminiEnabled) {
            throw new Error("Gemini API anahtarı yapılandırılmamış veya SDK yüklenememiş.");
        }

        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-05-20" });

        const historyPrompt = chatHistory.map(msg => `**${msg.role === 'user' ? 'Kullanıcı' : 'Asistan'}**: ${msg.text}`).join('\n');

        const prompt = `
            Sen Serakıncı Limited için bir müşteri destek asistanısın. Sadece hayvan sağlığı hakkında bilgi veriyorsun. 
            Şu an "${productName}" (${category}) ürünü hakkında konuşuyoruz. 
            Kullanıcı sorusu: "${question}".
            Önceki konuşma:
            ${historyPrompt}
            
            Lütfen bu ürüne odaklanarak, kısa, anlaşılır ve kullanıcı soruyu hangi dilde sormuş ise o dilde bir cevap ver Eğer kullanıcı isterse başka dilde de cevap ver ve yardımcı ol. Bilmediğin veya emin olmadığın konularda 'Bu konuda detaylı bilgi için lütfen veteriner hekiminize veya firmamıza danışın.' de. Tıbbı destek ya da tanı koyarsan eğer mutlaka yapay zeka olduğunu söyle, ürünlerin etken maddesi gibi özellikleri hakkında bilgi ver.
        `;

        try {
            const result = await model.generateContent(prompt);
            const response = result.response;
            return response.text();
        } catch (error) {
            console.error("AI Chat Hatası:", error);
            return "Üzgünüm, şu anda sorunuzu yanıtlayamıyorum. Lütfen daha sonra tekrar deneyin veya firmamızla iletişime geçin.";
        }
    }
    
    function setupAIFetchButton(product, enhancedDetail) { // enhancedDetail artık daha çok orijinal JSON verisi için
        // ... (Karşılaştırma butonu mantığı çıkarıldı, sadece AI bilgi al butonu kaldı)
        // İçerik bir önceki versiyondaki gibi, sadece addToCompareBtn ile ilgili kısımlar çıkarılacak
        const fetchBtn = document.getElementById('fetchAiInfoBtn');
        const placeholder = document.getElementById('aiProductInfoPlaceholder');
        if (!fetchBtn || !placeholder) return;

        let isAiEnabled = false;
        if (GEMINI_SDK_LOADED) {
            if (GEMINI_API_KEY === "AIzaSyBEpqKAEZKYSyznxeZsQ1MYO-9hqV5LGoA") {
                isAiEnabled = true;
            } else if (GEMINI_API_KEY && !GEMINI_API_KEY.includes("PLACEHOLDER")) {
                isAiEnabled = true;
            }
        }

        if (!isAiEnabled) {
            fetchBtn.disabled = true; 
            fetchBtn.style.cursor = 'not-allowed';
            fetchBtn.title = 'Yapay zeka modülü veya API anahtarı kullanılamıyor.';
            placeholder.innerHTML = `<div id="aiProductInfo" class="error-message"><p><em>Yapay zeka modülü (SDK) veya API anahtarı yapılandırılmadığı için bu özellik kullanılamıyor.</em></p></div>`; 
            return;
        }

        fetchBtn.addEventListener('click', async () => {
            fetchBtn.disabled = true; fetchBtn.innerHTML = `<span class="spinner"></span> Bilgi Üretiliyor...`; placeholder.innerHTML = ''; 
            
            // currentProduct.Description, AI tarafından otomatik doldurulmuş veya önbellekten gelmiş olabilir.
            const existingInfo = { 
                description: currentProduct.Description, 
                content: (enhancedDetail && enhancedDetail["Ürün İçeriği"]) || currentProduct.Content 
            };
            try {
                const aiData = await generateEnhancedProductInfo(currentProduct.ProductName, getProductCategory(currentProduct), 'tr', existingInfo); 
                placeholder.innerHTML = `<div id="aiProductInfo"><h4>Yapay Zeka Destekli Ek Bilgiler:</h4><p><strong>Detaylı Açıklama:</strong> ${aiData.enhancedDescription}</p>${aiData.keyFeatures && aiData.keyFeatures.length > 0 ? `<p><strong>Öne Çıkan Ek Özellikler:</strong></p><ul>${aiData.keyFeatures.map(f => `<li>${f}</li>`).join('')}</ul>` : ''}</div>`;
                fetchBtn.style.display = 'none'; 
            } catch (error) {
                placeholder.innerHTML = `<div id="aiProductInfo" class="error-message"><p><em>AI bilgisi oluşturulurken hata: ${error.message}.</em></p></div>`;
                fetchBtn.disabled = false; fetchBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5,12c2.2,0,4-1.8,4-4s-1.8-4-4-4s-4,1.8-4,4S13.3,12,15.5,12z M8.5,4C6.6,4,5,5.6,5,7.5S6.6,11,8.5,11S12,9.4,12,7.5S10.4,4,8.5,4z M3.5,19H2v-3c0-1.7,1.3-3,3-3h1.5c0.3-0.5,0.7-1,1.2-1.4C6.6,11.2,5.4,11,4,11C1.8,11,0,12.8,0,15v4h3.5V19z M16.5,14H14.5c-2.8,0-5,2.2-5,5v3h12v-3C21.5,16.2,19.3,14,16.5,14z"/></svg> Tekrar Dene`;
            }
        });
    }

    function setupChatbotModal() { /* ... (Aynı kalır) ... */ }
    function showTooltip(tooltipId, element, message) { /* ... (Aynı kalır) ... */ }
    function getProductCategory(product) { /* ... (Aynı kalır) ... */ }
    function slugify(text) { /* ... (Aynı kalır) ... */ }
    function getCurrentSegmentAndSlug() { /* ... (Aynı kalır) ... */ }
    async function fetchJsonData(fileName) { /* ... (Aynı kalır) ... */ }
    function showError(msg) { /* ... (Aynı kalır) ... */ }
    function loadFavorites() { /* ... (Aynı kalır) ... */ }
    function saveFavorites() { /* ... (Aynı kalır) ... */ }
    function isFavorite(productId) { /* ... (Aynı kalır) ... */ }
    function updateFavoritesCount() { /* ... (Aynı kalır) ... */ }
    function toggleFavorite(product, btnElement) { /* ... (Aynı kalır) ... */ }
    function displayFavorites() { /* ... (Aynı kalır) ... */ }
    function setupFavoritesModal() { /* ... (Aynı kalır) ... */ }

    // Karşılaştırma fonksiyonları (loadComparison, saveComparison, vb.) kaldırıldı.

    async function loadProductDetail(slugFromUrl, segmentName) {
        // ... (İçerik aynı, displayProductDetail çağrısı await olmadan kalır)
        // İçerik bir önceki versiyondaki gibi kalacak
        const productDetailContainer = document.getElementById('productDetailContainer');
        productDetailContainer.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><p class="loading-text">Ürün bilgileri yükleniyor...</p></div>`;

        try {
            const productsListFile = `${segmentName}.json`; 
            const [products, enhancedData] = await Promise.all([
              fetchJsonData(productsListFile), 
              fetchJsonData('hayvan-sagligi-enhanced.json') 
            ]);

            allProducts = products; 

            if (!Array.isArray(allProducts)) { showError('Ürün listesi yüklenemedi. Beklenmeyen format.'); return; }

            currentProduct = allProducts.find(p => p.ProductName && slugify(p.ProductName) === slugFromUrl);

            if (currentProduct) {
                const enhancedDetail = enhancedData.find(detail => detail.ProductId === currentProduct.ProductId);
                displayProductDetail(currentProduct, enhancedDetail, segmentName); // No await
                document.title = `${currentProduct.ProductName} | ${segmentName.charAt(0).toUpperCase() + segmentName.slice(1).replace('-', ' ')} | Serakıncı`;
                const canonicalLink = document.querySelector("link[rel='canonical']");
                if (canonicalLink) canonicalLink.href = window.location.href; 
            } else {
                showError('Aradığınız ürün bulunamadı veya bu kategoriye ait değil. URL\'yi kontrol edin.');
            }
        } catch (error) {
            console.error("loadProductDetail hatası:", error);
            showError(`Ürün bilgileri yüklenirken bir hata oluştu: ${error.message}. JSON dosyası formatı veya yolu hatalı olabilir.`);
        }
    }
    
    async function fetchAndFillDescriptionAI_Cached(product, enhancedDetail) {
        const cacheKey = `ai_description_${product.ProductId}`;
        const cachedAIDescription = localStorage.getItem(cacheKey);

        const shortDescEl = document.getElementById('product-short-description-content');
        const tab1DescEl = document.getElementById('product-tab1-description-content');

        if (cachedAIDescription) {
            console.log(`[AI Auto-Desc Post-Render] Önbellekten AI açıklaması yüklendi for "${product.ProductName}".`);
            if (shortDescEl) shortDescEl.innerHTML = cachedAIDescription;
            if (tab1DescEl) tab1DescEl.innerHTML = cachedAIDescription;
            product.Description = cachedAIDescription; 
            if (enhancedDetail) enhancedDetail["Ürün Açıklaması"] = cachedAIDescription;
            return; 
        }

        const currentDOMDescription = shortDescEl ? shortDescEl.textContent.trim() : "";
        const placeholderTexts = [
            "açıklama mevcut değil.",
            "bu ürün için açıklama şu anda üretilememektedir.",
            "otomatik açıklama üretilirken bir hata oluştu.",
            "açıklama mevcut değil (ai modülü etkin değil).",
            "açıklama mevcut değil (aı kapalı).", // Olası typo
            "yapay zeka ile açıklama üretilemedi.",
            "açıklama üretilirken hata oluştu."
        ];
        
        const isDescriptionTrulyMissing = (!currentDOMDescription || 
                                         currentDOMDescription === "" || 
                                         placeholderTexts.includes(currentDOMDescription.toLowerCase()));

        if (!isDescriptionTrulyMissing) {
            // Açıklama zaten JSON'dan gelmiş ve geçerli, API'ye gitmeye gerek yok.
            // Ama yine de product.Description'ı DOM'daki ile senkronize edelim.
            if(currentDOMDescription && product.Description !== currentDOMDescription){
                 product.Description = currentDOMDescription;
                 if (enhancedDetail) enhancedDetail["Ürün Açıklaması"] = currentDOMDescription;
            }
            return;
        }
        
        console.log(`[AI Auto-Desc Post-Render] Önbellek boş ve açıklama eksik for "${product.ProductName}". Gemini ile üretilecek.`);
            
        let isAiEnabled = false;
        if (GEMINI_SDK_LOADED) {
            if (GEMINI_API_KEY === "AIzaSyBEpqKAEZKYSyznxeZsQ1MYO-9hqV5LGoA" || (GEMINI_API_KEY && !GEMINI_API_KEY.includes("PLACEHOLDER"))) {
                isAiEnabled = true;
            }
        }

        if (!isAiEnabled) {
            console.warn(`[AI Auto-Desc Post-Render] Gemini modülü/API anahtarı kullanılamıyor for "${product.ProductName}".`);
            if (shortDescEl && placeholderTexts.includes(shortDescEl.textContent.trim().toLowerCase())) shortDescEl.textContent = "Açıklama mevcut değil (AI kapalı).";
            if (tab1DescEl && placeholderTexts.includes(tab1DescEl.textContent.trim().toLowerCase())) tab1DescEl.textContent = "Bu ürün için genel açıklama bulunmamaktadır (AI kapalı).";
            return;
        }

        try {
            if (shortDescEl) shortDescEl.textContent = "Yapay zeka ile açıklama üretiliyor...";
            if (tab1DescEl) tab1DescEl.textContent = "Yapay zeka ile açıklama üretiliyor...";

            const aiData = await generateEnhancedProductInfo(
                product.ProductName,
                getProductCategory(product),
                'tr',
                { 
                    description: 'Yok', 
                    content: (enhancedDetail && enhancedDetail["Ürün İçeriği"]) || product.Content || 'Yok' 
                }
            );

            if (aiData && aiData.enhancedDescription && 
                String(aiData.enhancedDescription).trim() !== "" &&
                !String(aiData.enhancedDescription).trim().toLowerCase().includes("detaylı bilgi bulunmamaktadır")) {
                
                const newDescription = aiData.enhancedDescription;
                console.log(`[AI Auto-Desc Post-Render] Gemini'den açıklama alındı for "${product.ProductName}". Updating DOM & Cache.`);

                if (shortDescEl) shortDescEl.innerHTML = newDescription;
                if (tab1DescEl) tab1DescEl.innerHTML = newDescription;
                
                localStorage.setItem(cacheKey, newDescription);
                product.Description = newDescription; 
                if (enhancedDetail) enhancedDetail["Ürün Açıklaması"] = newDescription;
            } else {
                console.warn(`[AI Auto-Desc Post-Render] Gemini'den geçerli bir açıklama alınamadı or 'bilgi yok' for "${product.ProductName}".`);
                 if (shortDescEl && shortDescEl.textContent.trim().toLowerCase().includes("üretiliyor")) shortDescEl.textContent = "Yapay zeka ile açıklama üretilemedi.";
                 if (tab1DescEl && tab1DescEl.textContent.trim().toLowerCase().includes("üretiliyor")) tab1DescEl.textContent = "Yapay zeka ile genel açıklama üretilemedi.";
            }
        } catch (error) {
            console.error(`[AI Auto-Desc Post-Render] Gemini ile otomatik açıklama üretilirken hata for "${product.ProductName}":`, error);
            if (shortDescEl && shortDescEl.textContent.trim().toLowerCase().includes("üretiliyor")) shortDescEl.textContent = "Açıklama üretilirken hata oluştu.";
            if (tab1DescEl && tab1DescEl.textContent.trim().toLowerCase().includes("üretiliyor")) tab1DescEl.textContent = "Genel açıklama üretilirken hata oluştu.";
        }
    }

    function displayProductDetail(product, enhancedDetail, segmentName) {
        const detailContainer = document.getElementById('productDetailContainer');
        
        // Önce localStorage'dan AI açıklamasını oku
        const cachedAIDescription = localStorage.getItem(`ai_description_${product.ProductId}`);
        let initialDescription;

        if (cachedAIDescription) {
            initialDescription = cachedAIDescription;
            console.log(`[DisplayProductDetail] Önbellekten AI açıklaması kullanılıyor: ${product.ProductName}`);
            // currentProduct ve enhancedDetail'i de senkronize et
            product.Description = initialDescription;
            if (enhancedDetail) {
                enhancedDetail["Ürün Açıklaması"] = initialDescription;
            }
        } else {
            initialDescription = (enhancedDetail && enhancedDetail["Ürün Açıklaması"]) || product.Description || "Açıklama mevcut değil.";
        }


        let imageUrl = product.ImageUrl || (product.ProductImages?.[0]?.ImageUrl) || FALLBACK_IMAGE_URL;
        const productCategory = getProductCategory(product);
        const isFav = isFavorite(product.ProductId);
        // isCmp kaldırıldı

        const imageHTML = `<div class="product-main-image-wrapper" id="mainProductImageWrapper"><img src="${imageUrl}" alt="${product.ProductName}" class="product-main-image-modern ${!imageUrl || imageUrl === FALLBACK_IMAGE_URL ? 'fallback-image' : ''}" onerror="this.onerror=null; this.src='${FALLBACK_IMAGE_URL}';" loading="lazy"></div>`;
        const favoriteButtonHTML = `<button class="favorite-button ${isFav ? 'favorited' : ''}" id="favoriteBtn" title="Favorilere Ekle/Çıkar"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button>`;

        let metaInfoHTML = '<div class="product-meta-enhanced">';
        if (productCategory && productCategory !== 'Diğer') metaInfoHTML += `<span class="meta-item"><strong>Kategori:</strong> ${productCategory}</span>`;
        const productCode = product.ProductCode || product.DisplayProductCode;
        if (productCode) metaInfoHTML += `<span class="meta-item"><strong>Ürün Kodu:</strong> <span id="productCodeValue">${productCode}</span> <span class="copy-code" title="Kodu Kopyala" onclick="window.copyProductCode(event)">(Kopyala)</span></span>`;
        if (enhancedDetail) { 
            if(enhancedDetail["Üretici Firma"] && enhancedDetail["Üretici Firma"].trim() !== "") metaInfoHTML += `<span class="meta-item"><strong>Üretici:</strong> ${enhancedDetail["Üretici Firma"]}</span>`;
            if(enhancedDetail["Firma Web Sitesi"] && enhancedDetail["Firma Web Sitesi"].trim() !== "" && (enhancedDetail["Firma Web Sitesi"].startsWith('http') || enhancedDetail["Firma Web Sitesi"].startsWith('www'))) metaInfoHTML += `<span class="meta-item"><strong>Web Sitesi:</strong> <a href="${enhancedDetail["Firma Web Sitesi"].startsWith('http') ? '' : 'http://'}${enhancedDetail["Firma Web Sitesi"]}" target="_blank" rel="noopener">Web Sitesini Ziyaret Et</a></span>`;
            if(enhancedDetail["Üretici Prospektüs"] && enhancedDetail["Üretici Prospektüs"].trim() !== "" && (enhancedDetail["Üretici Prospektüs"].startsWith('http') || enhancedDetail["Üretici Prospektüs"].startsWith('www'))) metaInfoHTML += `<span class="meta-item"><strong>Prospektüs:</strong> <a href="${enhancedDetail["Üretici Prospektüs"].startsWith('http') ? '' : 'http://'}${enhancedDetail["Üretici Prospektüs"]}" target="_blank" rel="noopener">Prospektüsü Görüntüle</a></span>`;
        }
        metaInfoHTML += '</div>';

        const productUrl = window.location.href;
        const shareText = encodeURIComponent(`Serakıncı'da ${product.ProductName} ürününü inceleyin:`);
        const shareButtonsHTML = `<div class="product-share-buttons"><span class="share-label">Paylaş:</span><a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}" target="_blank" title="Facebook'ta Paylaş"><svg viewBox="0 0 24 24" fill="#1877F2"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/></svg></a><a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(productUrl)}&text=${shareText}" target="_blank" title="Twitter'da Paylaş"><svg viewBox="0 0 24 24"><path fill="#1DA1F2" d="M22.46 6c-.77.35-1.6.58-2.46.67.9-.53 1.59-1.37 1.92-2.38-.84.5-1.78.86-2.79 1.07C18.28 4.47 17.03 4 15.64 4c-2.97 0-5.32 2.44-5.32 5.45 0 .42.05.84.14 1.24C7.08 10.5 4.07 8.76 2.05 6.12c-.44.75-.69 1.62-.69 2.55 0 1.88 1 3.55 2.4 4.52-.88-.03-1.7-.27-2.42-.66v.07c0 2.63 1.85 4.82 4.3 5.32-.45.12-.93.18-1.42.18-.34 0-.68-.03-1-.1C4.56 19.95 6.43 21.3 8.63 21.3c-1.84 1.44-4.17 2.3-6.7 2.3-.43 0-.86-.02-1.28-.08C3.38 22.89 5.92 24 8.78 24c7.22 0 11.6-6.12 11.12-12.07.79-.57 1.47-1.29 2-2.06z"/></svg></a><a href="https://api.whatsapp.com/send?text=${shareText} ${encodeURIComponent(productUrl)}" target="_blank" title="WhatsApp'ta Paylaş"><svg viewBox="0 0 24 24"><path fill="#25D366" d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.38 1.25 4.8L2 22l5.29-1.38c1.37.71 2.93 1.12 4.56 1.12h.1c5.46 0 9.91-4.45 9.91-9.91S17.68 2 12.04 2zm4.64 12.13c-.14-.07-.86-.42-1-.49-.14-.07-.24-.11-.34.11-.1.22-.38.49-.47.59-.09.1-.18.11-.34.04-.16-.07-.68-.25-1.29-.79-.48-.42-.79-.94-.88-1.1s-.09-.25 0-.38c.08-.11.18-.28.28-.42.09-.14.14-.25.2-.42.07-.18.04-.33-.02-.44s-.34-.81-.47-1.1c-.12-.29-.25-.25-.34-.25-.09 0-.18 0-.28.02s-.24.11-.38.38c-.14.28-.54.86-.54 1.5s.54 1.74.62 1.86c.08.11.97 1.48 2.42 2.03.34.14.61.21.82.28.29.09.54.08.74.02.22-.07.68-.28.78-.55.1-.28.1-.51.07-.59s-.14-.11-.3-.18z"/></svg></a></div>`;
        
        const shortDescriptionHTML = `<div class="product-short-description"><p id="product-short-description-content">${initialDescription}</p></div>`;
        
        // aiButtonHTML sadece AI ile Bilgi Al butonunu içerecek
        const aiButtonHTML = `
            <div id="ai-button-container">
                <button id="fetchAiInfoBtn" title="Yapay Zeka ile ürün hakkında daha fazla bilgi alın">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5,12c2.2,0,4-1.8,4-4s-1.8-4-4-4s-4,1.8-4,4S13.3,12,15.5,12z M8.5,4C6.6,4,5,5.6,5,7.5S6.6,11,8.5,11S12,9.4,12,7.5S10.4,4,8.5,4z M3.5,19H2v-3c0-1.7,1.3-3,3-3h1.5c0.3-0.5,0.7-1,1.2-1.4C6.6,11.2,5.4,11,4,11C1.8,11,0,12.8,0,15v4h3.5V19z M16.5,14H14.5c-2.8,0-5,2.2-5,5v3h12v-3C21.5,16.2,19.3,14,16.5,14z"/></svg>
                    AI ile Bilgi Al
                </button>
                <div id="aiProductInfoPlaceholder"></div>
            </div>`;

        const tab1Content = `<h3>Genel Açıklama</h3><p id="product-tab1-description-content">${initialDescription}</p>`;
        const tab2Content = `<h3>Ürün İçeriği</h3><p>${(enhancedDetail?.["Ürün İçeriği"] || product.Content) && String(enhancedDetail?.["Ürün İçeriği"] || product.Content).trim() !== '' ? (enhancedDetail?.["Ürün İçeriği"] || product.Content) : "Bileşen listesi için ambalajdaki etiket incelenmelidir."}</p>`;
        let tab3Content = `<h3>Dikkat Edilmesi Gerekenler / Uyarılar</h3><ul>${enhancedDetail?.["Dikkat edilmesi gerekenler ya da uyarılar"]?.map(item => `<li>${item}</li>`).join('') || "<li>Bu ürün için özel uyarı bulunmamaktadır.</li>"}</ul><h3>Kullanım İpuçları ve En İyi Uygulamalar</h3><ul>${enhancedDetail?.["Kullanım İpuçları ve En İyi Uygulamalar"]?.map(item => `<li>${item}</li>`).join('') || "<li>Bu ürün için özel kullanım ipucu bulunmamaktadır.</li>"}</ul>`;
        let tab4Content = `<h3>Sıkça Sorulan Sorular</h3>${enhancedDetail && enhancedDetail["Sıkça Sorulan Sorular"]?.length ? `<div class="faq-container">${enhancedDetail["Sıkça Sorulan Sorular"].map(faq => `<div class="faq-item"><details><summary>${faq.question}</summary><div class="faq-answer"><p>${faq.answer}</p></div></details></div>`).join('')}</div>` : '<p>Bu ürün için sıkça sorulan soru bulunmamaktadır.</p>'}`;

        const relatedProductsHTML = getRelatedProductsHTML(product, segmentName, allProducts);
        const disclaimerHTML = getDisclaimerHTML();
        const contactHTML = getContactHTML();

        const categoryLink = productCategory && productCategory !== 'Diğer' ? `/urunler/${segmentName}/?kategori=${slugify(productCategory)}` : `/urunler/${segmentName}/`;
        const categoryText = productCategory && productCategory !== 'Diğer' ? `"${productCategory}" Kategorisine Dön` : `${segmentName.charAt(0).toUpperCase() + segmentName.slice(1).replace('-', ' ')} Ürünlerine Dön`;
        const backButtonHTML = `
            <div id="backButtonsContainer" style="margin-top: 2.5rem; display: flex; flex-wrap: wrap; gap: 10px;">
                ${document.referrer && document.referrer.includes(window.location.host) ? `<a href="#" class="back-button-modern" onclick="event.preventDefault(); window.history.back();"><span class="back-icon">←</span> Önceki Sayfaya Dön</a>` : ''}
                <a href="${categoryLink}" class="back-button-modern"><span class="back-icon">‹</span> ${categoryText}</a>
            </div>`;

        detailContainer.innerHTML = `
            <nav class="breadcrumbs" id="breadcrumbsContainer">
                <a href="https://www.serakinci.com" class="breadcrumb-link">Ana Sayfa</a><span class="breadcrumb-separator">></span>
                <a href="/urunler/" class="breadcrumb-link">Ürünler</a><span class="breadcrumb-separator">></span>
                <a href="/urunler/${segmentName}/" class="breadcrumb-link">${segmentName.charAt(0).toUpperCase() + segmentName.slice(1).replace('-', ' ')}</a>
                ${productCategory && productCategory !== 'Diğer' ? `<span class="breadcrumb-separator">></span> <a href="${categoryLink}" class="breadcrumb-link">${productCategory}</a>` : ''}
                <span class="breadcrumb-separator">></span><span class="breadcrumb-current">${product.ProductName}</span>
            </nav>
            <div class="product-main-layout">
                <div class="product-gallery-modern">${imageHTML}</div>
                <div class="product-info-modern">
                    <div class="product-title-wrapper"><h1 class="product-title-modern">${product.ProductName}</h1>${favoriteButtonHTML}</div>
                    ${metaInfoHTML}${shareButtonsHTML}${shortDescriptionHTML}${aiButtonHTML}
                </div>
            </div>
            <div class="product-details-tabs-modern">
                <div class="tabs-navigation-modern">
                    <button class="tab-link-modern active" data-tab="tab1">Genel Açıklama</button>
                    <button class="tab-link-modern" data-tab="tab2">İçerik Bilgisi</button>
                    <button class="tab-link-modern" data-tab="tab3">Kullanım ve Uyarılar</button>
                    <button class="tab-link-modern" data-tab="tab4">S.S.S.</button>
                </div>
                <div class="tab-content-modern">
                    <div id="tab1" class="tab-pane-modern active">${tab1Content}</div>
                    <div id="tab2" class="tab-pane-modern">${tab2Content}</div>
                    <div id="tab3" class="tab-pane-modern">${tab3Content}</div>
                    <div id="tab4" class="tab-pane-modern">${tab4Content}</div>
                </div>
            </div>
            ${relatedProductsHTML}
            ${disclaimerHTML}
            ${contactHTML}
            ${backButtonHTML}
        `;

        setupTabEvents(); 
        const favBtn = document.getElementById('favoriteBtn');
        if (favBtn) favBtn.onclick = (e) => toggleFavorite(product, e.currentTarget);

        // addToCompareBtn ile ilgili onclick kaldırıldı.
        
        setupMainImageLightbox(imageUrl);
        // enhancedDetail or product (currentProduct)
        setupAIFetchButton(currentProduct, enhancedDetail); // Pass currentProduct for potentially updated desc
        
        fetchAndFillDescriptionAI_Cached(currentProduct, enhancedDetail);
    }

    function getRelatedProductsHTML(currentProduct, segmentName, allProducts) { /* ... (Aynı kalır) ... */ }
    function getDisclaimerHTML() { /* ... (Aynı kalır) ... */ }
    function getContactHTML() { /* ... (Aynı kalır) ... */ }
    function setupTabEvents() { /* ... (Aynı kalır) ... */ }
    function setupMainImageLightbox(imageUrl) { /* ... (Aynı kalır) ... */ }
    function setupLightbox() { /* ... (Aynı kalır) ... */ }
    function setupScrollToTopButton() { /* ... (Aynı kalır) ... */ }
    window.copyProductCode = function(event) { /* ... (Aynı kalır) ... */ }
    window.scrollCarousel = function(direction, containerId) { /* ... (Aynı kalır) ... */ }
    async function setupProductSearch() { /* ... (Aynı kalır, allProducts null/undefined kontrolü eklendi) ... */ }
    function setupMobileMenu() { /* ... (Aynı kalır) ... */ }

    document.addEventListener('DOMContentLoaded', async function() {
        const currentYearEl = document.getElementById('currentYear');
        if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();

        loadFavorites();
        // loadComparison(); kaldırıldı

        setupMobileMenu(); 
        setupScrollToTopButton();
        setupLightbox();
        setupFavoritesModal();
        // setupComparisonModal(); kaldırıldı
        setupChatbotModal(); 
        
        await setupProductSearch(); 

        const { segment: detectedSegment, slug: slugFromUrl } = getCurrentSegmentAndSlug();
        currentSegment = detectedSegment; 

        if (slugFromUrl && currentSegment) {
            await loadProductDetail(slugFromUrl, currentSegment); 
        } else {
            // ... (Hata yönetimi veya varsayılan sayfa içeriği aynı kalır)
            const detailContainer = document.getElementById('productDetailContainer');
            if(detailContainer && (!slugFromUrl || !currentSegment) && window.location.pathname.includes('/product/')) { 
                 showError('Ürün bilgisi alınamadı. URL yapısı hatalı veya eksik. Lütfen geçerli bir ürün URL\'si ile gelin. Örnek: `/urunler/hayvan-sagligi/product/multivit-100ml-enj/`');
            } else if (detailContainer && detailContainer.querySelector('.loading-container')) {
                 if (!window.location.pathname.includes('/product/')) { 
                    detailContainer.innerHTML = ''; 
                 }
            }
        }
    });
  </script>
